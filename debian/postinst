#!/bin/sh
set -e

cat << EOF > /etc/apt/sources.list
# Do not edit this file, it will be overwritten

# Current testing release is forky
deb http://deb.debian.org/debian forky main contrib non-free non-free-firmware
deb http://deb.debian.org/debian-security forky-security main contrib non-free non-free-firmware
deb http://deb.debian.org/debian forky-updates main contrib non-free non-free-firmware

# We use the current stable release (trixie) as a fallback because packages sometimes disappear
# from testing due to automated QA
deb http://deb.debian.org/debian trixie main contrib non-free non-free-firmware
deb http://deb.debian.org/debian-security trixie-security main contrib non-free non-free-firmware
deb http://deb.debian.org/debian trixie-updates main contrib non-free non-free-firmware
EOF

cat << EOF > /etc/apt/preferences.d/90-stable-fallback
# Do not edit this file, it will be overwritten

# We use the current stable release (trixie) as a fallback because packages sometimes disappear
# from testing due to automated QA, but we give it a lower priority than the default 500 used for
# the main repository
Package: *
Pin: release n=trixie
Pin-Priority: 400
EOF

MODPATH=/etc/initramfs-tools/modules
for MOD in lz4 z3fold zswap; do
    if ! grep -q "^${MOD}$" ${MODPATH}; then
        echo "Adding ${MOD} to ${MODPATH}"
        echo ${MOD} >> ${MODPATH}
    fi
done

update-initramfs -k all -u
update-grub

#DEBHELPER#
